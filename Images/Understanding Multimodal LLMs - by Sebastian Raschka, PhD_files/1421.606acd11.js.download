"use strict";(self.webpackChunksubstack=self.webpackChunksubstack||[]).push([["1421"],{8923:function(e,t,n){n.d(t,{$1:()=>p,Sn:()=>m,wg:()=>c});var o=n(7409),a=n(99282),r=n(16584),i=n(6400),l=n(30396),s=n(80569),d=n.n(s);let u=(0,i.createContext)({oauthAccessToken:null,isOAuthProvider:!1}),c=()=>(0,l.qp)(u);function p(e){let t=t=>{let{oauthAccessToken:n}=c();return(0,r.tZ)(e,(0,a._)((0,o._)({},t),{oauthAccessToken:n}))};return t.displayName="WithOAuthEmbed(".concat(e.displayName||e.name||"Component",")"),t}let m=()=>{let{oauthAccessToken:e}=c();return(0,l.Ye)(()=>{let t=t=>(e&&t.set("Authorization","Bearer ".concat(e)),t);return{get:e=>t(d().get(e)),post:e=>t(d().post(e)),put:e=>t(d().put(e)),delete:e=>t(d().delete(e)),patch:e=>t(d().patch(e))}},[e])}},41990:function(e,t,n){n.d(t,{_:()=>L});var o=n(7409),a=n(99282),r=n(58865),i=n(16584),l=n(98661),s=n(30396),d=n(94184),u=n.n(d),c=n(80569),p=n.n(c),m=n(18787),f=n(66149),g=n(95441),h=n(8923),y=n(16451),_=n(68833),v=n(48980),b=n(98914),w=n(26419),S=n(70841),C=n(46638),Z=n(12900),N=n(15771),O=n(82402),P=n(19081),I=n(43570),E=n(58175),T=n(440),k=n(70379),x=n(37155),R=n(31377),B=n(60308),M=n(63651),X=n(84864),A=n(60648);function J(){let e=(0,r._)(["Only "," subscribers can comment on this post"]);return J=function(){return e},e}let F="commentInput",L=(0,l.forwardRef)((e,t)=>{let{commentBeingEdited:n,parent:r,post:l,autoFocus:d,formClassName:c,saveEdit:m,onCancel:f,onSuccess:y,user:w,freeSignup:Z,freeSignupEmail:N,pub:O,token:I,bannedFromNotes:E,alwaysShowButtons:T,mediaClipId:R}=e,{iString:J}=(0,g.M1)(),L=(0,k.pm)(),D=(0,h.Sn)(),{isOAuthProvider:j,oauthAccessToken:H}=(0,h.wg)(),[W,z]=(0,s.eJ)(!1),[U,Y]=(0,s.eJ)(null),[G,V]=(0,s.eJ)(!1),[$,Q]=(0,s.eJ)(!1),ee=(0,s.Ye)(()=>{if("undefined"!=typeof localStorage){let e=JSON.parse(localStorage.getItem(F)||"{}");if(e.postId===l.id)return{value:e.value,alsoShareToNotes:!!e.alsoShareToNotes};localStorage.removeItem(F)}},[]),et=(0,o._)({value:null==n?void 0:n.body,alsoShareToNotes:!1,loading:!1,error:null},ee),[{value:en,alsoShareToNotes:eo,loading:ea,error:er},ei]=(0,s.eJ)(et),el=e=>ei(t=>(0,a._)((0,o._)({},t),{value:e})),es=(0,s.sO)(null),ed=(0,s.sO)(null);(0,s.aP)(t,()=>({focus(){var e;null===(e=es.current)||void 0===e||e.focus()},getTextareaRef:()=>es}),[]),(0,s.d4)(()=>{if(d){var e;null===(e=es.current)||void 0===e||e.focus()}},[]);let eu=!(null==w?void 0:w.name),[ec,ep]=(0,s.eJ)(!1),em=async()=>{(0,_.j)(_.FP.COMMENT_PAYWALL_SHOWN,{post_id:l.id,post_type:l.type,parent_id:null==r?void 0:r.id}),ep(!0)},ef=async()=>{(0,_.j)(_.FP.FINISH_MAGIC_LOGIN_MODAL_SHOWN,{post_id:l.id,post_type:l.type,parent_id:null==r?void 0:r.id}),await ev(),Q(!0)},[eg,eh]=(0,s.eJ)(!1),ey=async()=>{(0,_.j)(_.FP.PROFILE_UPDATER_SHOWN,{post_id:l.id,parent_id:null==r?void 0:r.id}),eh(!0)},e_=(0,s.sO)(!1),ev=async()=>{if(!w){console.error("cannot sendLoginEmail, user not defined");return}if(!e_.current){e_.current=!0;try{var e;let t=await (0,v.rd)("/api/v1/email-login",{method:"POST",json:{email:w.email,redirect:null===(e=document.location.href.split("?")[0])||void 0===e?void 0:e.split("#")[0]}});"optional"===t.verification_code&&(z(!0),t.onboarding_redirect&&Y(t.onboarding_redirect))}catch(e){alert((0,b.zx)(e))}}},eb=()=>{localStorage.setItem(F,JSON.stringify({postId:l.id,value:en,alsoShareToNotes:eo}))},ew=async()=>{if(n){ei(e=>(0,a._)((0,o._)({},e),{loading:!0}));try{let e=await (null==m?void 0:m(en));eC(e)}catch(e){ei(t=>(0,a._)((0,o._)({},t),{loading:!1,error:e}))}}else eS()},eS=async function(){var e;let{profileUpdated:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(ea)return;if(!(0,X.canPostComments)(w,l,O).canReply){eb(),await em(),await (0,x.g)(600),ei(e=>(0,a._)((0,o._)({},e),{error:J("Please sign in.")}));return}if(eu&&!t){eb(),j?(V(!0),ei(e=>(0,a._)((0,o._)({},e),{loading:!1,error:J("Please set your profile name to comment.")}))):(V(!1),await ey(),await (0,x.g)(600),ei(e=>(0,a._)((0,o._)({},e),{error:J("Please update your profile.")})));return}ei(e=>(0,a._)((0,o._)({},e),{loading:!0}));let n={body:null===(e=es.current)||void 0===e?void 0:e.value,token:I};R&&(n.mediaClipId=R);try{let e;if(eo){let t=await D.post("/api/v1/comment/attachment").send({type:"link",url:r?(0,C.aE)(l,r,O):(0,B.uRy)(O,l)}),a=null==t?void 0:t.body;if(a){let t=(0,o._)({},n);t.attachmentIds=[a.id],e=await D.post("/api/v1/comment/feed").send(t)}else console.warn("Error creating attachment")}r&&(n.parent_id=r.id);let t=await D.post("/api/v1/post/".concat(l.id,"/comment")).send(n);if(localStorage.removeItem(F),!(null==w?void 0:w.profile_set_up_at)&&!j){let{body:{count:e}}=await p().get("/api/v1/user/profile_role_count");if(e>=2){let e=(0,B.n1t)("".concat((0,B.ZJn)(),"/profile/start"),{commentProfileFlow:!0,next:(0,C.aE)(l,t.body,O)});return(0,b.uX)(e),!1}}eC({notesComment:e,res:t})}catch(e){e.response&&403===e.response.statusCode&&(w&&w.is_magic?await ef():await em()),ei(t=>(0,a._)((0,o._)({},t),{loading:!1,error:e}))}},eC=e=>{let{res:t,notesComment:n}=e;if(!1!==t){if(y&&!eu){if(eo&&n){let e=(0,M.Sgq)(n.body);L.popToast(t=>(0,i.tZ)(k.FN,(0,a._)((0,o._)({},t),{text:J("Shared to Notes"),cta:J("View Now"),href:e})))}el(""),y(t.body)}else{let e=(0,C.Os)(l,O);j?(0,b.uX)((0,C.fg)(l,O,null!=H?H:"")):window.location.pathname===e?window.location.reload():(0,b.uX)((0,C.Os)(l,O,eo?{feedCommentUrl:(0,M.Sgq)(t.body)}:{}))}ei(e=>(0,a._)((0,o._)({},e),{loading:!1}))}};return(0,i.BX)(P.hs,{"data-test-id":"comment-input",flex:"grow",className:u()({comment:n}),children:[(0,i.tZ)("form",{className:u()(A.Z.form,c),onSubmit:e=>{e.preventDefault(),ew()},ref:ed,children:(0,i.tZ)(q,{user:w,commentBeingEdited:n,post:l,pub:O,value:en,bodyInputRef:es,onInput:e=>{let t=e.currentTarget.value;if(!(0,X.canPostComments)(w,l,O).canReply){e.preventDefault(),em();return}el(t)},onKeyDown:e=>{var t,n;if(null==w?void 0:w.is_magic){e&&e.preventDefault(),ef();return}if(!(0,X.canPostComments)(w,l,O).canReply){e.preventDefault(),em();return}"Escape"===e.key&&(null===(t=es.current)||void 0===t?void 0:t.value.trim())===""?(null===(n=es.current)||void 0===n||n.blur(),null==f||f()):"Enter"===e.key&&e.metaKey&&ew()},bannedFromNotes:E,alsoShareToNotes:eo,onShareToNotesChange:()=>ei(e=>(0,a._)((0,o._)({},e),{alsoShareToNotes:!eo})),onCancel:()=>{f?f():el("")},error:er,loading:ea,alwaysShowButtons:T,isReplying:!!r,showProfileSetupLinkOnError:G})}),(0,i.tZ)(K,{user:w,freeSignup:Z,freeSignupEmail:N,pub:O,post:l,token:I,isProfileUpdateModalOpen:eg,setIsProfileUpdateModalOpen:eh,isPaywallModalOpen:ec,setIsPaywallModalOpen:ep,onProfileUpdaterSuccess:e=>"boolean"!=typeof e||!!(e&&eS({profileUpdated:e}))}),(0,i.tZ)(S.L,{isOpen:$,onClose:()=>Q(!1),user:w,pub:O,otpLoginEnabled:W,onboardingRedirect:U})]})}),D=e=>{let{error:t,showProfileSetupLinkOnError:n}=e,{iString:o}=(0,g.M1)();if(!t)return null;let a="string"==typeof t?t:(0,b.zx)(t,"Something went wrong.");return(0,i.BX)(P.hs,{direction:"column",gap:4,children:[(0,i.tZ)(I.Vp,{priority:"secondary",theme:"error",flex:"auto",children:a}),n&&(0,i.tZ)(E.xv.B3,{children:(0,i.tZ)("a",{href:"".concat((0,B.ZJn)(),"/profile/edit"),target:"_blank",children:o("Set up profile")})})]})},j=e=>{let{alsoShareToNotes:t,onChange:n}=e,{iString:o}=(0,g.M1)();return(0,i.BX)(P.hs,{as:"label",gap:12,alignItems:"center",justifyContent:"center",children:[(0,i.tZ)(O.X,{name:"also_feed",checked:t,onChange:n}),(0,i.tZ)(E.xv.B3,{color:"secondary",children:o("Also share to Notes")})]})},H=e=>{let{bodyInputRef:t,value:n,onInput:o,onKeyDown:a,iString:r,disabled:l}=e;return(0,i.tZ)(T.l,{ref:t,name:"body",placeholder:r("Write a comment..."),defaultRows:4,maxRows:24,value:n||"",onInput:o,onKeyDown:a,className:A.Z.input,disabled:l,"aria-label":r("Write a comment...")})},W=e=>{let{isEditing:t,isReplying:n,bannedFromNotes:o,alsoShareToNotes:a,onShareToNotesChange:r,onCancel:l,loading:s,disableSubmit:d}=e;return(0,i.BX)(P.X2,{alignItems:"center",justifyContent:"space-between",children:[!t&&!o&&(0,i.tZ)(j,{alsoShareToNotes:a,onChange:r}),(0,i.BX)(z,{children:[(0,i.tZ)(U,{onCancel:l}),(0,i.tZ)(Y,{isEditing:t,isReplying:n,loading:s,disabled:d})]})]})},z=e=>{let{children:t}=e;return(0,i.tZ)(P.X2,{gap:8,justifyContent:"end",flex:"grow",children:t})},U=e=>{let{onCancel:t}=e,{iString:n}=(0,g.M1)();return(0,i.tZ)(N.zx,{priority:"secondary",onClick:t,children:n("Cancel")})},Y=e=>{let{isEditing:t,isReplying:n,loading:o,disabled:a}=e,{iString:r}=(0,g.M1)();return(0,i.tZ)(N.zx,{priority:"primary",type:"submit",loading:o,disabled:a,children:r(t?"Save":n?"Reply":"Post")})},K=e=>{let{user:t,freeSignup:n,freeSignupEmail:o,pub:a,post:r,token:l,isProfileUpdateModalOpen:s,setIsProfileUpdateModalOpen:d,isPaywallModalOpen:u,setIsPaywallModalOpen:c,onProfileUpdaterSuccess:p}=e,{iString:h,iTemplate:y}=(0,g.M1)();return(0,i.BX)(i.HY,{children:[(0,i.tZ)(f.EB,{isOpen:s,onClose:e=>{d(!1),p(e)},user:t,freeSignup:n,freeSignupEmail:o,optionalPhoto:!0,token:l,text:h("Save and post comment")}),(0,i.tZ)(m.sF,{isOpen:u,onClose:()=>c(!1),user:t,freeSignup:n,freeSignupEmail:o,publication:a,post:r,title:y(J(),(0,R.isFoundingAudience)(r.audience)?"founding":"paid"),reauthenticationTitle:h("To post a comment, please re-authenticate.")})]})},q=e=>{let{user:t,commentBeingEdited:n,post:o,pub:a,value:r,bodyInputRef:l,onInput:s,onKeyDown:d,bannedFromNotes:u,alsoShareToNotes:c,onShareToNotesChange:p,onCancel:m,error:f,loading:h,alwaysShowButtons:_,isReplying:v,showProfileSetupLinkOnError:b}=e,{iString:S}=(0,g.M1)(),C=!(null==r?void 0:r.trim());return(0,i.BX)(i.HY,{children:[(0,i.tZ)(y.Zb,{size:32,user:t}),(0,i.BX)(P.tu,{flex:"grow",gap:8,children:[n&&(0,i.tZ)(w.J,{comment:n,post:o,pub:a,isCollapsed:!0,userBanned:!1,hideContextMenu:!0,onChange:()=>{},startEdit:()=>{},startReport:()=>{},openBan:()=>{}}),(0,i.tZ)(H,{bodyInputRef:l,value:r,onInput:s,onKeyDown:d,iString:S,disabled:h}),(0,i.tZ)(D,{error:f,showProfileSetupLinkOnError:b}),(0,i.tZ)(Z.H,{expanded:!C||!!_,clip:!1,children:(0,i.tZ)(W,{isReplying:v,isEditing:!!n,bannedFromNotes:u,alsoShareToNotes:c,onShareToNotesChange:p,onCancel:m,loading:h,disableSubmit:C})})]})]})}}}]);