"use strict";(self.webpackChunksubstack=self.webpackChunksubstack||[]).push([["1421"],{8923:function(e,t,n){n.d(t,{$1:()=>p,Sn:()=>m,wg:()=>c});var o=n(7409),r=n(99282),a=n(16584),i=n(6400),l=n(30396),s=n(80569),d=n.n(s);let u=(0,i.createContext)({oauthAccessToken:null,isOAuthProvider:!1}),c=()=>(0,l.qp)(u);function p(e){let t=t=>{let{oauthAccessToken:n}=c();return(0,a.tZ)(e,(0,r._)((0,o._)({},t),{oauthAccessToken:n}))};return t.displayName="WithOAuthEmbed(".concat(e.displayName||e.name||"Component",")"),t}let m=()=>{let{oauthAccessToken:e}=c();return(0,l.Ye)(()=>{let t=t=>(e&&t.set("Authorization","Bearer ".concat(e)),t);return{get:e=>t(d().get(e)),post:e=>t(d().post(e)),put:e=>t(d().put(e)),delete:e=>t(d().delete(e)),patch:e=>t(d().patch(e))}},[e])}},41990:function(e,t,n){n.d(t,{_:()=>j});var o=n(7409),r=n(99282),a=n(58865),i=n(16584),l=n(98661),s=n(30396),d=n(94184),u=n.n(d),c=n(80569),p=n.n(c),m=n(18787),f=n(96726),h=n(31704),g=n(347),y=n(95441),v=n(8923),_=n(16451),b=n(68833),w=n(48980),S=n(98914),Z=n(26419),C=n(70841),N=n(46638),O=n(12900),P=n(15771),E=n(82402),I=n(19081),R=n(43570),T=n(58175),k=n(440),x=n(70379),B=n(37155),X=n(31377),A=n(60308),M=n(63651),F=n(84864),J=n(60648);function L(){let e=(0,a._)(["Only "," subscribers can comment on this post"]);return L=function(){return e},e}let D="commentInput",j=(0,l.forwardRef)((e,t)=>{let{commentBeingEdited:n,parent:a,post:l,autoFocus:d,formClassName:c,saveEdit:m,onCancel:f,onSuccess:h,user:_,freeSignup:Z,freeSignupEmail:O,pub:P,token:E,bannedFromNotes:R,alwaysShowButtons:T,mediaClipId:k}=e,{iString:X}=(0,y.M1)(),L=(0,x.pm)(),j=(0,v.Sn)(),{isOAuthProvider:W,oauthAccessToken:z}=(0,v.wg)(),[H,U]=(0,s.eJ)(!1),[K,Y]=(0,s.eJ)(null),[q,$]=(0,s.eJ)(!1),[Q,ee]=(0,s.eJ)(!1),et=(0,s.Ye)(()=>{if("undefined"!=typeof localStorage){let e=JSON.parse(localStorage.getItem(D)||"{}");if(e.postId===l.id)return{value:e.value,alsoShareToNotes:!!e.alsoShareToNotes};localStorage.removeItem(D)}},[]),en=(0,o._)({value:null==n?void 0:n.body,alsoShareToNotes:!1,loading:!1,error:null},et),[{value:eo,alsoShareToNotes:er,loading:ea,error:ei},el]=(0,s.eJ)(en),es=e=>el(t=>(0,r._)((0,o._)({},t),{value:e})),ed=(0,s.sO)(null),eu=(0,s.sO)(null);(0,s.aP)(t,()=>({focus(){var e;null===(e=ed.current)||void 0===e||e.focus()},getTextareaRef:()=>ed}),[]),(0,s.d4)(()=>{if(d){var e;null===(e=ed.current)||void 0===e||e.focus()}},[]);let ec=!(null==_?void 0:_.name),ep=(0,s.sO)(),em=async()=>{var e;(0,b.j)(b.FP.COMMENT_PAYWALL_SHOWN,{post_id:l.id,post_type:l.type,parent_id:null==a?void 0:a.id}),await (null===(e=ep.current)||void 0===e?void 0:e.open())},ef=async()=>{(0,b.j)(b.FP.FINISH_MAGIC_LOGIN_MODAL_SHOWN,{post_id:l.id,post_type:l.type,parent_id:null==a?void 0:a.id}),await ev(),ee(!0)},eh=(0,s.sO)(),eg=async()=>{var e;(0,b.j)(b.FP.PROFILE_UPDATER_SHOWN,{post_id:l.id,parent_id:null==a?void 0:a.id}),await (null===(e=eh.current)||void 0===e?void 0:e.open())},ey=(0,s.sO)(!1),ev=async()=>{if(!_){console.error("cannot sendLoginEmail, user not defined");return}if(!ey.current){ey.current=!0;try{var e;let t=await (0,w.rd)("/api/v1/email-login",{method:"POST",json:{email:_.email,redirect:null===(e=document.location.href.split("?")[0])||void 0===e?void 0:e.split("#")[0]}});"optional"===t.verification_code&&(U(!0),t.onboarding_redirect&&Y(t.onboarding_redirect))}catch(e){alert((0,S.zx)(e))}}},e_=()=>{localStorage.setItem(D,JSON.stringify({postId:l.id,value:eo,alsoShareToNotes:er}))},eb=async()=>{if(n){el(e=>(0,r._)((0,o._)({},e),{loading:!0}));try{let e=await (null==m?void 0:m(eo));eS(e)}catch(e){el(t=>(0,r._)((0,o._)({},t),{loading:!1,error:e}))}}else ew()},ew=async function(){var e;let{profileUpdated:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(ea)return;if(!(0,F.canPostComments)(_,l,P).canReply){e_(),await em(),await (0,B.g)(600),el(e=>(0,r._)((0,o._)({},e),{error:X("Please sign in.")}));return}if(ec&&!t){e_(),W?($(!0),el(e=>(0,r._)((0,o._)({},e),{loading:!1,error:X("Please set your profile name to comment.")}))):($(!1),await eg(),await (0,B.g)(600),el(e=>(0,r._)((0,o._)({},e),{error:X("Please update your profile.")})));return}el(e=>(0,r._)((0,o._)({},e),{loading:!0}));let n={body:null===(e=ed.current)||void 0===e?void 0:e.value,token:E};k&&(n.mediaClipId=k);try{let e;if(er){let t=await j.post("/api/v1/comment/attachment").send({type:"link",url:a?(0,N.aE)(l,a,P):(0,A.uRy)(P,l)}),r=null==t?void 0:t.body;if(r){let t=(0,o._)({},n);t.attachmentIds=[r.id],e=await j.post("/api/v1/comment/feed").send(t)}else console.warn("Error creating attachment")}a&&(n.parent_id=a.id);let t=await j.post("/api/v1/post/".concat(l.id,"/comment")).send(n);if(localStorage.removeItem(D),!(null==_?void 0:_.profile_set_up_at)&&!W){let{body:{count:e}}=await p().get("/api/v1/user/profile_role_count");if(e>=2){let e=(0,A.n1t)("".concat((0,A.ZJn)(),"/profile/start"),{commentProfileFlow:!0,next:(0,N.aE)(l,t.body,P)});return(0,S.uX)(e),!1}}eS({notesComment:e,res:t})}catch(e){e.response&&403===e.response.statusCode&&(_&&_.is_magic?await ef():await em()),el(t=>(0,r._)((0,o._)({},t),{loading:!1,error:e}))}},eS=e=>{let{res:t,notesComment:n}=e;if(!1!==t){if(h&&!ec){if(er&&n){let e=(0,M.Sgq)(n.body);L.popToast(t=>(0,i.tZ)(x.FN,(0,r._)((0,o._)({},t),{text:X("Shared to Notes"),cta:X("View Now"),href:e})))}es(""),h(t.body)}else{let e=(0,N.Os)(l,P);W?(0,S.uX)((0,N.fg)(l,P,null!=z?z:"")):window.location.pathname===e?window.location.reload():(0,S.uX)((0,N.Os)(l,P,er?{feedCommentUrl:(0,M.Sgq)(t.body)}:{}))}el(e=>(0,r._)((0,o._)({},e),{loading:!1}))}};return(0,i.tZ)(g.h,{children:(0,i.BX)(I.hs,{"data-test-id":"comment-input",flex:"grow",className:u()({comment:n}),children:[(0,i.tZ)("form",{className:u()(J.Z.form,c),onSubmit:e=>{e.preventDefault(),eb()},ref:eu,children:(0,i.tZ)(V,{user:_,commentBeingEdited:n,post:l,pub:P,value:eo,bodyInputRef:ed,onInput:e=>{let t=e.currentTarget.value;if(!(0,F.canPostComments)(_,l,P).canReply){e.preventDefault(),em();return}es(t)},onKeyDown:e=>{var t,n;if(null==_?void 0:_.is_magic){e&&e.preventDefault(),ef();return}if(!(0,F.canPostComments)(_,l,P).canReply){e.preventDefault(),em();return}"Escape"===e.key&&(null===(t=ed.current)||void 0===t?void 0:t.value.trim())===""?(null===(n=ed.current)||void 0===n||n.blur(),null==f||f()):"Enter"===e.key&&e.metaKey&&eb()},bannedFromNotes:R,alsoShareToNotes:er,onShareToNotesChange:()=>el(e=>(0,r._)((0,o._)({},e),{alsoShareToNotes:!er})),onCancel:()=>{f?f():es("")},error:ei,loading:ea,alwaysShowButtons:T,isReplying:!!a,showProfileSetupLinkOnError:q})}),(0,i.tZ)(G,{user:_,freeSignup:Z,freeSignupEmail:O,pub:P,post:l,token:E,profileUpdaterRef:eh,modalPaywallRef:ep,onProfileUpdaterSuccess:e=>"boolean"!=typeof e||!!(e&&ew({profileUpdated:e}))}),(0,i.tZ)(C.L,{isOpen:Q,onClose:()=>ee(!1),user:_,pub:P,otpLoginEnabled:H,onboardingRedirect:K})]})})}),W=e=>{let{error:t,showProfileSetupLinkOnError:n}=e,{iString:o}=(0,y.M1)();if(!t)return null;let r="string"==typeof t?t:(0,S.zx)(t,"Something went wrong.");return(0,i.BX)(I.hs,{direction:"column",gap:4,children:[(0,i.tZ)(R.Vp,{priority:"secondary",theme:"error",flex:"auto",children:r}),n&&(0,i.tZ)(T.xv.B3,{children:(0,i.tZ)("a",{href:"".concat((0,A.ZJn)(),"/profile/edit"),target:"_blank",children:o("Set up profile")})})]})},z=e=>{let{alsoShareToNotes:t,onChange:n}=e,{iString:o}=(0,y.M1)();return(0,i.BX)(I.hs,{as:"label",gap:12,alignItems:"center",justifyContent:"center",children:[(0,i.tZ)(E.X,{name:"also_feed",checked:t,onChange:n}),(0,i.tZ)(T.xv.B3,{color:"secondary",children:o("Also share to Notes")})]})},H=e=>{let{bodyInputRef:t,value:n,onInput:o,onKeyDown:r,iString:a,disabled:l}=e;return(0,i.tZ)(k.l,{ref:t,name:"body",placeholder:a("Write a comment..."),defaultRows:4,maxRows:24,value:n||"",onInput:o,onKeyDown:r,className:J.Z.input,disabled:l,"aria-label":a("Write a comment...")})},U=e=>{let{isEditing:t,isReplying:n,bannedFromNotes:o,alsoShareToNotes:r,onShareToNotesChange:a,onCancel:l,loading:s,disableSubmit:d}=e;return(0,i.BX)(I.X2,{alignItems:"center",justifyContent:"space-between",children:[!t&&!o&&(0,i.tZ)(z,{alsoShareToNotes:r,onChange:a}),(0,i.BX)(K,{children:[(0,i.tZ)(Y,{onCancel:l}),(0,i.tZ)(q,{isEditing:t,isReplying:n,loading:s,disabled:d})]})]})},K=e=>{let{children:t}=e;return(0,i.tZ)(I.X2,{gap:8,justifyContent:"end",flex:"grow",children:t})},Y=e=>{let{onCancel:t}=e,{iString:n}=(0,y.M1)();return(0,i.tZ)(P.zx,{priority:"secondary",onClick:t,children:n("Cancel")})},q=e=>{let{isEditing:t,isReplying:n,loading:o,disabled:r}=e,{iString:a}=(0,y.M1)();return(0,i.tZ)(P.zx,{priority:"primary",type:"submit",loading:o,disabled:r,children:a(t?"Save":n?"Reply":"Post")})},G=e=>{let{user:t,freeSignup:n,freeSignupEmail:o,pub:r,post:a,token:l,profileUpdaterRef:s,modalPaywallRef:d,onProfileUpdaterSuccess:u}=e,{iString:c,iTemplate:p}=(0,y.M1)();return(0,i.BX)(f.h,{children:[(0,i.tZ)(h.EB,{ref:s,user:t,freeSignup:n,freeSignupEmail:o,optionalPhoto:!0,token:l,text:c("Save and post comment"),onBeforeClose:u}),(0,i.tZ)(m.sF,{ref:d,user:t,freeSignup:n,freeSignupEmail:o,publication:r,post:a,title:p(L(),(0,X.isFoundingAudience)(a.audience)?"founding":"paid"),reauthenticationTitle:c("To post a comment, please re-authenticate.")})]})},V=e=>{let{user:t,commentBeingEdited:n,post:o,pub:r,value:a,bodyInputRef:l,onInput:s,onKeyDown:d,bannedFromNotes:u,alsoShareToNotes:c,onShareToNotesChange:p,onCancel:m,error:f,loading:h,alwaysShowButtons:g,isReplying:v,showProfileSetupLinkOnError:b}=e,{iString:w}=(0,y.M1)(),S=!(null==a?void 0:a.trim());return(0,i.BX)(i.HY,{children:[(0,i.tZ)(_.Zb,{size:32,user:t}),(0,i.BX)(I.tu,{flex:"grow",gap:8,children:[n&&(0,i.tZ)(Z.J,{comment:n,post:o,pub:r,isCollapsed:!0,userBanned:!1,hideContextMenu:!0,onChange:()=>{},startEdit:()=>{},startReport:()=>{},openBan:()=>{}}),(0,i.tZ)(H,{bodyInputRef:l,value:a,onInput:s,onKeyDown:d,iString:w,disabled:h}),(0,i.tZ)(W,{error:f,showProfileSetupLinkOnError:b}),(0,i.tZ)(O.H,{expanded:!S||!!g,clip:!1,children:(0,i.tZ)(U,{isReplying:v,isEditing:!!n,bannedFromNotes:u,alsoShareToNotes:c,onShareToNotesChange:p,onCancel:m,loading:h,disableSubmit:S})})]})]})}}}]);